# Spody AI Dating Platform - Cursor Rules

## Project Overview
Spody is a React-based AI dating platform where users chat with AI characters. Uses Supabase for backend and OpenRouter for AI completions.

## ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ê–†–•–ò–¢–ï–ö–¢–£–†–ù–´–ï –ü–†–ê–í–ò–õ–ê (–ø–æ—Å–ª–µ 12.06.2025)

### üö® –¢–û–õ–¨–ö–û SUPABASE - –ù–ò–ö–ê–ö–ò–• MOCK_MODELS
- **–ö–†–ò–¢–ò–ß–ù–û**: –°–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¢–û–õ–¨–ö–û –¥–∞–Ω–Ω—ã–µ –∏–∑ Supabase
- **–£–î–ê–õ–ï–ù–û**: –í—Å–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ MOCK_MODELS –ø–æ–ª–Ω–æ—Å—Ç—å—é —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã
- **–§–∞–π–ª—ã**: ModelCatalog.js, AIProfile.js, ChatContext.js, SwipeCarousel.js, ChatPage.js
- **–ü—Ä–∞–≤–∏–ª–æ**: –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –¥–æ–±–∞–≤–ª—è–π fallback –Ω–∞ –º–æ–∫-–¥–∞–Ω–Ω—ã–µ

### üîê –ë–ï–ó–û–ü–ê–°–ù–´–ï SUPABASE –ó–ê–ü–†–û–°–´
- **–ó–ê–ü–†–ï–©–ï–ù–û**: `.single()` –∑–∞–ø—Ä–æ—Å—ã (–≤—ã–∑—ã–≤–∞—é—Ç –æ—à–∏–±–∫–∏ 406/400)
- **–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û**: –ò—Å–ø–æ–ª—å–∑—É–π –º–∞—Å—Å–∏–≤—ã + optional chaining
```javascript
// ‚ùå –û–ü–ê–°–ù–û
const { data } = await supabase.from('table').select().single();

// ‚úÖ –ë–ï–ó–û–ü–ê–°–ù–û  
const { data: array } = await supabase.from('table').select();
const item = array?.[0];
```

### üéØ –õ–û–ì–ò–ö–ê –ù–ê–í–ò–ì–ê–¶–ò–ò –ß–ê–¢–û–í
- **–ö–†–ò–¢–ò–ß–ù–û**: –ü—Ä–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É —á–∞—Ç—É –í–°–ï–ì–î–ê –¥–æ–±–∞–≤–ª—è–π `return;`
```javascript
// AIProfile.js –ø–∞—Ç—Ç–µ—Ä–Ω
if (existingChat) {
  navigate(`/chat/${existingChat.id}`);
  return; // –ö–†–ò–¢–ò–ß–ù–û - –∏–Ω–∞—á–µ —Å–æ–∑–¥–∞—Å—Ç—Å—è –¥—É–±–ª–∏–∫–∞—Ç
}
```

### üì± –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê –õ–ê–ô–ö–û–í
- **SwipeCarousel.js**: –£–±—Ä–∞–Ω—ã –±–ª–æ–∫–∏—Ä—É—é—â–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
- **–õ–æ–≥–∏–∫–∞**: –ª–∞–π–∫ ‚Üí –º–µ—Ç—á ‚Üí –ø–æ–ø–∞–ø ‚Üí —á–∞—Ç (–ø—Ä–æ—Å—Ç–∞—è —Ü–µ–ø–æ—á–∫–∞)
- **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è**: –°–∫—Ä—ã–≤–∞—é—Ç—Å—è –¢–û–õ–¨–ö–û –º–æ–¥–µ–ª–∏ —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏ —á–∞—Ç–∞–º–∏

## Authentication System  
- **ALWAYS use UnifiedAuthContext** for user authentication
- Import: `import { useAuth } from '../contexts/UnifiedAuthContext'`
- Never mix auth contexts - causes redirect bugs
- User state: `const { user } = useAuth()`

## AI Chat Integration
- **OpenRouter API** via `unifiedOpenRouterService.js`
- Model: `mistralai/mistral-medium-3` 
- **Critical**: Streaming responses must accumulate chunks, not replace
- Pattern: `accumulatedContent += chunk` (not `content = chunk`)

### **üîß –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–º–ø—Ç–æ–≤ (–ò–°–ü–†–ê–í–õ–ï–ù–û 12.06.2025)**
- **–ö–†–ò–¢–ò–ß–ù–û**: –°–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –û–ë–ù–û–í–õ–Ø–¢–¨–°–Ø, –∞ –Ω–µ –ø—Ä–æ–ø—É—Å–∫–∞—Ç—å—Å—è
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø—Ä–æ–º–ø—Ç–æ–≤: `custom_prompt` ‚Üí `template_prompt` ‚Üí `fallback`
- **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞** —Ñ—É–Ω–∫—Ü–∏—è `addSystemPrompt` –≤ `unifiedOpenRouterService.js`
- –¢–µ–ø–µ—Ä—å –∑–∞–º–µ–Ω—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–æ–≤—ã–º–∏ –ø—Ä–æ–º–ø—Ç–∞–º–∏
- **–ü–∞—Ç—Ç–µ—Ä–Ω –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è**: `messages[systemIndex] = { role: 'system', content: newPrompt }`

### Service Architecture
- `unifiedOpenRouterService.js` - AI API calls + **—Å–∏—Å—Ç–µ–º–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã**
- `unifiedPromptsService.js` - Prompt management + –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ  
- `UnifiedAuthContext.js` - Authentication
- `supabaseClient.js` - Database operations

## Code Quality Standards

### React Patterns
- Use functional components with hooks
- Context for global state (auth, chat, theme)
- Custom hooks for complex logic
- Error boundaries with graceful fallbacks

### Error Handling
- Try Supabase first, NO fallback to mock data (–∏–∑–º–µ–Ω–µ–Ω–æ)
- SVG fallbacks for failed image loads
- Graceful degradation for API failures

### Styling Approach
- CSS custom properties for theming
- Mobile-first responsive design
- Consistent component structure
- Use existing color variables

## Critical Bug Patterns to Avoid

### **üö® –°–∏—Å—Ç–µ–º–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã**
- ‚ùå Don't skip existing system messages: `if (hasSystemMessage) return messages`
- ‚úÖ Always update system messages: `messages[systemIndex] = newSystemMessage`
- ‚ùå Don't ignore custom_prompt from ai_models table
- ‚úÖ Load and apply character-specific prompts correctly

### **üö® MOCK_MODELS (–£–°–¢–†–ê–ù–ï–ù–û)**
- ‚ùå Don't use ANY MOCK_MODELS fallbacks
- ‚úÖ Load ONLY from Supabase ai_models table
- ‚ùå Don't mix string IDs with UUIDs
- ‚úÖ Use consistent UUID format everywhere

### **üö® Supabase .single() –∑–∞–ø—Ä–æ—Å—ã**
- ‚ùå Don't use .single() - causes 406/400 errors
- ‚úÖ Use array queries with optional chaining
- ‚ùå Don't assume records exist
- ‚úÖ Handle empty results gracefully

### Streaming Messages
- ‚ùå Don't replace content with each chunk
- ‚úÖ Always accumulate: `content += newChunk`
- Test streaming thoroughly - only shows last char if broken

### Authentication
- ‚ùå Don't import user from ChatContext  
- ‚úÖ Always use UnifiedAuthContext for user state
- Check auth redirects on "Start Dialog" flows

### **üö® Chat Navigation (–ò–°–ü–†–ê–í–õ–ï–ù–û)**
- ‚ùå Don't create new chats when existing ones found
- ‚úÖ Navigate to existing + return immediately
- ‚ùå Don't continue execution after navigation
- ‚úÖ Use pattern: `navigate() ‚Üí return;`

### Import Conflicts
- Ensure single source of truth for each service
- Watch for duplicate context providers
- Use unified services, not legacy alternatives

## –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã

### **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–æ–≤**
- –ò—Å–ø–æ–ª—å–∑—É–π `window.unifiedPrompts.getPrompts()` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏
- –ò—Å–ø–æ–ª—å–∑—É–π `window.unifiedOpenRouter.streamChatResponse()` –¥–ª—è –ø—Ä—è–º—ã—Ö API —Ç–µ—Å—Ç–æ–≤
- –°—Ä–∞–≤–Ω–∏–≤–∞–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä—è–º–æ–≥–æ API —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ —á–µ—Ä–µ–∑ ChatContext
- –ü—Ä–æ–≤–µ—Ä—è–π –ª–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏: `üîÑ –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ`

### –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–µ—Ñ–∏–∫—Å—ã: `üöÄ [UNIFIED OPENROUTER]`, `üìä [UNIFIED PROMPTS]`
- –õ–æ–≥–∏—Ä—É–π –≤—Å–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã –∏ –∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–π –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –ø—Ä–æ–º–ø—Ç–æ–≤

## Database Schema Key Points
- `users` - User profiles and auth
- `ai_models` - Character definitions + **custom_prompt –ø–æ–ª–µ**
- `chats` - User-AI conversations  
- `chat_messages` - Individual messages
- Row Level Security (RLS) enabled

## Development Workflow
1. Test auth flows first (login ‚Üí profile ‚Üí chat)
2. **Verify custom prompts apply correctly** (–Ω–æ–≤–æ–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ)
3. Verify streaming works end-to-end  
4. Check mobile responsiveness
5. Build without errors before committing
6. Monitor console for prompt update logs

## Environment Variables
- `REACT_APP_SUPABASE_URL`
- `REACT_APP_SUPABASE_ANON_KEY` 
- `REACT_APP_OPENROUTER_API_KEY`

## Memory Bank System
Project uses Memory Bank in `/memory-bank/` folder:
- `projectbrief.md` - Core project overview
- `activeContext.md` - Current work status  
- `progress.md` - Feature completion tracking
- `systemPatterns.md` - Architecture decisions
- `techContext.md` - Technology stack details
- `productContext.md` - Product vision and UX

Read Memory Bank files at start of each session for full context.

## **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∑–Ω–∞–Ω–∏—è –¥–ª—è —Ä–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º (–û–ë–ù–û–í–õ–ï–ù–û 12.06.2025)**

### 1. –ü—Ä–æ–±–ª–µ–º–∞ MOCK_MODELS (–†–ï–®–ï–ù–ê –ù–ê–í–°–ï–ì–î–ê)
**–°–∏–º–ø—Ç–æ–º**: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ ID, —á–∞—Ç—ã —Å –Ω–µ–≤–µ—Ä–Ω—ã–º–∏ –º–æ–¥–µ–ª—è–º–∏  
**–†–µ—à–µ–Ω–∏–µ**: –ü–æ–ª–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö MOCK_MODELS –∏–∑ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ù–ê–í–°–ï–ì–î–ê –†–ï–®–ï–ù–ê - –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–æ–∫–∏

### 2. –ü—Ä–æ–±–ª–µ–º–∞ .single() –∑–∞–ø—Ä–æ—Å–æ–≤ (–†–ï–®–ï–ù–ê)
**–°–∏–º–ø—Ç–æ–º**: –û—à–∏–±–∫–∏ 406/400 –≤ –∫–æ–Ω—Å–æ–ª–∏  
**–†–µ—à–µ–Ω–∏–µ**: –ó–∞–º–µ–Ω–∞ –Ω–∞ –º–∞—Å—Å–∏–≤—ã + optional chaining  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –†–ï–®–ï–ù–ê –≤–æ –≤—Å–µ—Ö —Ñ–∞–π–ª–∞—Ö

### 3. –ü—Ä–æ–±–ª–µ–º–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ —á–∞—Ç–æ–≤ (–†–ï–®–ï–ù–ê)
**–°–∏–º–ø—Ç–æ–º**: –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö —á–∞—Ç–æ–≤ –≤–º–µ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö  
**–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–ª–µ–Ω `return;` –ø–æ—Å–ª–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É —á–∞—Ç—É  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –†–ï–®–ï–ù–ê –≤ AIProfile.js

### 4. –ü—Ä–æ–±–ª–µ–º–∞ –∞–≤–∞—Ç–∞—Ä–æ–≤ (–†–ï–®–ï–ù–ê)
**–°–∏–º–ø—Ç–æ–º**: –ê–≤–∞—Ç–∞—Ä—ã –Ω–µ –∑–∞–≥—Ä—É–∂–∞–ª–∏—Å—å –≤ —á–∞—Ç–∞—Ö  
**–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∞ —Å–≤–µ–∂–∏—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ ai_models  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –†–ï–®–ï–ù–ê –≤ ChatPage.js –∏ ChatContext.js

### 5. –ü—Ä–æ–±–ª–µ–º–∞ –ª–∞–π–∫–æ–≤ –≤ —Å–≤–∞–π–ø–∞—Ö (–†–ï–®–ï–ù–ê)
**–°–∏–º–ø—Ç–æ–º**: –õ–∞–π–∫ –Ω–µ —Å–æ–∑–¥–∞–≤–∞–ª –º–µ—Ç—á, —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–ª–∏—Å—Ç—ã–≤–∞–ª  
**–†–µ—à–µ–Ω–∏–µ**: –£–±—Ä–∞–Ω—ã –±–ª–æ–∫–∏—Ä—É—é—â–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –†–ï–®–ï–ù–ê –≤ SwipeCarousel.js

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ —Å –ø—Ä–æ–º–ø—Ç–∞–º–∏ (12.06.2025)
**–°–∏–º–ø—Ç–æ–º**: –ö–∞—Å—Ç–æ–º–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã –∏–∑ CRM –Ω–µ –ø—Ä–∏–º–µ–Ω—è–ª–∏—Å—å –≤ —á–∞—Ç–∞—Ö
**–ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞**: `addSystemPrompt` –≤–æ–∑–≤—Ä–∞—â–∞–ª –º–∞—Å—Å–∏–≤ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
**–†–µ—à–µ–Ω–∏–µ**: –ó–∞–º–µ–Ω—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–æ–≤—ã–º –ø—Ä–æ–º–ø—Ç–æ–º –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
**–†–µ–∑—É–ª—å—Ç–∞—Ç**: ‚úÖ –ü–µ—Ä–≤—ã–µ –æ—Ç–≤–µ—Ç—ã —Ç–µ–ø–µ—Ä—å —Ç–æ—á–Ω–æ —Å–ª–µ–¥—É—é—Ç –ø—Ä–æ–º–ø—Ç–∞–º (95% —Ç–æ—á–Ω–æ—Å—Ç—å)

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω
```
CRM (—Å–æ–∑–¥–∞–Ω–∏–µ custom_prompt) 
  ‚Üì
Supabase (ai_models.custom_prompt) 
  ‚Üì
unifiedPromptsService (–∑–∞–≥—Ä—É–∑–∫–∞ + –∫–µ—à)
  ‚Üì
unifiedOpenRouterService (–ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∫ messages)
  ‚Üì
OpenRouter API (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–æ–≤)
```

## **–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞ (12.06.2025)**
- ‚úÖ –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –±–∞–≥–∏ —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã
- ‚úÖ –ü—Ä–æ–µ–∫—Ç —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- ‚úÖ –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ
- ‚úÖ –ì–æ—Ç–æ–≤ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É
- ‚ö†Ô∏è –¢–æ–ª—å–∫–æ ESLint warnings (–Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ)